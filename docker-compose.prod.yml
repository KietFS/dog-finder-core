version: '3.9'

# ─────────────────────────────────────────────────────────────────────────────
# PRODUCTION – AWS EC2 deployment
# Connects to AWS RDS (PostgreSQL) and AWS ElastiCache (Redis).
# All secrets must be supplied via environment variables or AWS Secrets Manager.
#
# Usage on EC2:
#   docker compose -f docker-compose.prod.yml up -d
# ─────────────────────────────────────────────────────────────────────────────

services:
  app:
    image: ${DOCKER_IMAGE:-dog-finder-core:latest}  # Override with ECR image URI
    container_name: dog-finder-app
    ports:
      - '${PORT:-3000}:3000'
    environment:
      NODE_ENV: production
      PORT: ${PORT:-3000}
      API_PREFIX: ${API_PREFIX:-api/v1}

      # ── AWS RDS (PostgreSQL) ──────────────────────────────────────────────
      DB_HOST: ${DB_HOST}               # e.g. mydb.xxxxxx.us-east-1.rds.amazonaws.com
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_SYNCHRONIZE: 'false'           # Always false in production; use migrations
      DB_LOGGING: 'false'

      # ── AWS ElastiCache (Redis) ───────────────────────────────────────────
      REDIS_HOST: ${REDIS_HOST}         # e.g. myredis.xxxxxx.cfg.use1.cache.amazonaws.com
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_TTL: ${REDIS_TTL:-3600}
      REDIS_TLS: ${REDIS_TLS:-false}    # Set to 'true' if in-transit encryption is enabled

      # ── Seeding (disabled in production) ────────────────────────────────
      SEED_DB: 'false'

      # ── Swagger ───────────────────────────────────────────────────────────
      SWAGGER_ENABLED: ${SWAGGER_ENABLED:-false}   # Disable in production by default
      SWAGGER_TITLE: ${SWAGGER_TITLE:-Dog Finder API}
      SWAGGER_DESCRIPTION: ${SWAGGER_DESCRIPTION:-Production-ready RESTful API that mimics TheDogAPI}
      SWAGGER_VERSION: ${SWAGGER_VERSION:-1.0}
      SWAGGER_PATH: ${SWAGGER_PATH:-api}

      # ── Pagination ────────────────────────────────────────────────────────
      DEFAULT_PAGE_SIZE: ${DEFAULT_PAGE_SIZE:-10}
      MAX_PAGE_SIZE: ${MAX_PAGE_SIZE:-100}

    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://localhost:3000/api/v1/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: always
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
