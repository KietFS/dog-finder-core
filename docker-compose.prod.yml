version: '3.9'

services:
  app:
    image: ${DOCKER_IMAGE:-dog-finder-core:latest}
    container_name: dog-finder-app
    ports:
      - '${PORT:-3000}:3000'
    environment:
      NODE_ENV: production
      PORT: ${PORT:-3000}
      API_PREFIX: ${API_PREFIX:-api/v1}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE: ${DB_DATABASE}
      DB_SYNCHRONIZE: 'false'
      DB_LOGGING: 'false'
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_TTL: ${REDIS_TTL:-3600}
      REDIS_TLS: 'false'
      SEED_DB: 'false'
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO- http://localhost:3000/api/v1/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: always
    networks:
      - dog-finder-network
    depends_on:
      redis:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: dog-finder-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - dog-finder-network

networks:
  dog-finder-network:
    driver: bridge

volumes:
  redis_data: